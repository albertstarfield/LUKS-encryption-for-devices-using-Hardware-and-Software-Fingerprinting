#!/bin/bash
# use reencrypt
#https://superuser.com/questions/216879/encrypt-an-existing-partition-in-linux-while-preserving-its-data
#https://unix.stackexchange.com/questions/444931/is-there-a-way-to-encrypt-disk-without-formatting-it
if [ ! -f /tmp/keyHash ] && [ ! -f /tmp/keyHashRequestRegen ]; then
echo "hash trust key has been expired, please reboot to renew the system state and the key to create LUKS Volume"
echo "However if you are insisting to do so you can add flag to /tmp/keyHashRequestRegen, it is not recommended"
exit
else
echo $(bash /encryptStorageTrustTool/hwswhashd > /dev/null 2>&1 ) &
fi
reset
#cryptsetup reencrypt --encrypt /dev/sdXY --reduce-device-size 32M
echo "caching keyHash"
echo "Check your partition UUID"
echo "======"
lsblk
blkid
echo "======"
echo -n "partition/Volume UUID to encrypt:" 
set -e
read diskUUID
echo ""
echo -n "What will you name the Volume? :"
read sessionName
echo -n "What is the Volume mounting point on the system? :"
read mountingpoint
if [ -z "${diskUUID}" ] && [ -z "${sessionName}" ] && [ -z "${mountingpoint}" ]; then
echo "A blank required Input detected..."
echo "Setup is cancelled"
exit
fi

echo "[0/4] Enter or Define your backup password for renewingthe TrustHash key later"
cryptsetup reencrypt --encrypt /dev/disk/by-uuid/${diskUUID} --reduce-device-size 32M
echo "[1/4] Correcting Filesystem Size..."
resize2fs /dev/disk/by-uuid/${diskUUID}
echo "[2/4] Checking for any Filesystem Errors"
fsck /dev/disk/by-uuid/${diskUUID} -y
echo "[3/4] Registering new diskUUID to the configuration..."
namefile=${diskUUID}_volume_autoGenerated.conf
cryptsetup luksDump /dev/disk/by-uuid/${diskUUID}
#====
echo '# this is configuration for mounting the disk or partition' > ${namefile}
echo "sessionName=${sessionName}" >> ${namefile}
echo "diskUUID=${diskUUID}" >> ${namefile}
echo "mountingpoint=${mountingpoint}" >> ${namefile}
echo "# This configuration is autogenerated by the setup at $(date)" >> ${namefile}
#====
echo "[4/4] Recalling Hash key daemon"
echo $(bash /encryptStorageTrustTool/hwswhashd > /dev/null 2>&1 ) &
bash /encryptStorageTrustTool/renewTrustHashKey
echo "Finished!"
echo "To get the disk Automatically Authenticated you can try to reboot your machine or environment"
exit
